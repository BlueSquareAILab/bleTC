# BLE 총기 격발 센서 

## 1. 소개

이 문서는 블루투스 저에너지(BLE) 기술을 이용한 총기 반동 감지 시스템의 개발자 메뉴얼입니다. 이 시스템은 총기의 블로우 백 반동을 자석 센서로 감지하고, 그 데이터를 BLE를 통해 전송합니다. 

## 2. 시스템 개요

- 하드웨어: ESP32 기반 BLE 칩, A3144 홀 효과 센서
- 통신 프로토콜: Bluetooth Low Energy (BLE)
- 데이터 형식: JSON

## 3. BLE 서비스 정보

- 서비스 UUID: 2ca354b0-5f62-11ef-b4d4-f7af9038ee7d
- 특성 UUID: 35c34c80-5f62-11ef-b4d4-f7af9038ee7d
- 디바이스 이름: "BSQTC_" + ChipID

## 4. 통신 프로토콜

### 4.1 명령어 형식

명령어는 문자열 형태로 전송되며 **, 또는 공백** 으로 구분된 토큰으로 구성됩니다.

### 4.2 주요 명령어

1. `about`: 장치 정보 조회
2. `status`: 현재 상태 조회 (트리거 카운트, 모드, 배터리 레벨)
3. `clear`: 트리거 카운트 초기화
4. `ble info`: BLE 관련 정보 조회
5. 'config [set,get,dump]': 설정 조회 및 변경
6. save , load : 설정 저장 및 불러오기

### 4.3 응답 형식

모든 응답은 JSON 형식으로 반환됩니다. 기본 구조는 다음과 같습니다:

```json
{
  "result": "ok" or "fail",
  "ms": "메시지 (선택적)",
  // 기타 명령어별 특정 필드들
}
```

## 5. Unity에서의 구현 가이드

### 5.1 BLE 플러그인

Unity에서 BLE 통신을 구현하기 위해서는 적절한 플러그인을 사용해야 합니다.  
이 예제는 windows OS 용, 오픈소스 [BleWinrt](https://github.com/adabru/BleWinrtDll) 플러그인을 사용합니다.  



### 5.2 연결 및 통신 구현

1. 디바이스 스캔:
   - "BSQTC_"로 시작하는 디바이스 이름을 찾습니다.

2. 연결:
   - 발견된 디바이스에 연결합니다.

3. 서비스 및 특성 검색:
   - 서비스 UUID: 2ca354b0-5f62-11ef-b4d4-f7af9038ee7d
   - 특성 UUID: 35c34c80-5f62-11ef-b4d4-f7af9038ee7d

4. 통신:
   - 특성에 Write 요청을 보내 명령어를 전송합니다.
   - Notify를 활성화하여 실시간 데이터를 수신합니다.

### 5.3 데이터 처리

1. 트리거 이벤트:
   - Notify를 통해 "#,count,0,0,0" 형식의 문자열을 수신합니다.
   - 두 번째 필드(count)가 트리거 카운트입니다.

2. 상태 조회:
   - "status" 명령어를 전송하고 JSON 응답을 파싱합니다.
   - battery 필드가 배터리 잔량을 %로 표시합니다.

3. 초기화:
   - 게임 시작 시 "clear" 명령어를 전송하여 카운트를 초기화합니다.

4. debounce 설정:
   - 트리거 이벤트를 처리할 때 디바운스를 적용합니다.
   - 예 : config set debounceDelay 100 (단위: ms)

